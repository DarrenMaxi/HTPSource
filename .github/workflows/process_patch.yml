name: Process New Patch Submission

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  build-and-pr:
    # ä»…å½“ Issue åŒ…å« "new-patch" æ ‡ç­¾æ—¶è¿è¡Œ
    if: contains(github.event.issue.labels.*.name, 'new-patch')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add problem matcher
        run: echo "::add-matcher::.github/problem-matcher.json"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Comment on issue (In Progress)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– æ”¶åˆ°æ‚¨çš„è¡¥ä¸æäº¤ï¼æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...'
            })

      - name: Run Processing Script
        id: process
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.repository.name }}
        run: python .github/scripts/process_patch.py
        
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(patch): Add/Update patch ${{ steps.process.outputs.patch_id }} v${{ steps.process.outputs.patch_version }}"
          branch: "patches/${{ steps.process.outputs.patch_id }}-${{ steps.process.outputs.patch_version }}"
          delete-branch: true
          title: "è¡¥ä¸æ›´æ–°: ${{ steps.process.outputs.patch_name }} v${{ steps.process.outputs.patch_version }}"
          body: |
            æ­¤ PR ç”±æœºå™¨äººæ ¹æ® Issue #${{ github.event.issue.number }} è‡ªåŠ¨åˆ›å»ºã€‚

            **è¡¥ä¸ä¿¡æ¯:**
            - **åç§°**: ${{ steps.process.outputs.patch_name }}
            - **ID**: `${{ steps.process.outputs.patch_id }}`
            - **ç‰ˆæœ¬**: `${{ steps.process.outputs.patch_version }}`
            - **ä½œè€…**: `${{ steps.process.outputs.patch_author }}`
            
            è¯·å®¡æŸ¥æ–‡ä»¶å˜æ›´æ˜¯å¦æ­£ç¡®ã€‚åˆå¹¶åï¼Œè¡¥ä¸å°†å¯¹ç”¨æˆ·å¯è§ã€‚
            
            Closes #${{ github.event.issue.number }}
          labels: patch, automated-pr
          
      - name: Comment on issue (Success)
        if: steps.cpr.outputs.pull-request-number
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… è‡ªåŠ¨åŒ–å¤„ç†å®Œæˆï¼\n\nå·²ä¸ºæ‚¨åˆ›å»º Pull Request: #${{steps.cpr.outputs.pull-request-number}}ï¼Œè¯·å‰å¾€å®¡æŸ¥ã€‚\n\næ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼`
            })
            
      - name: Comment on issue (Failure)
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ å¤„ç†å¤±è´¥ï¼\n\næœºå™¨äººæ— æ³•è‡ªåŠ¨å¤„ç†æ‚¨çš„æäº¤ã€‚è¯·æ£€æŸ¥æ‚¨å¡«å†™çš„ä¿¡æ¯å’Œä¸Šä¼ çš„æ–‡ä»¶æ˜¯å¦ç¬¦åˆè§„èŒƒã€‚\n\nå¸¸è§çš„é”™è¯¯åŸå› ï¼š\n- æœªä¸Šä¼  `.zip` é™„ä»¶ã€‚\n- `.zip` å‹ç¼©åŒ…å†…ä¸åªåŒ…å« `overrides` æ–‡ä»¶å¤¹ã€‚\n- è¡¨å•ä¿¡æ¯å¡«å†™ä¸å®Œæ•´æˆ–æ ¼å¼é”™è¯¯ã€‚\n\nä»“åº“ç»´æŠ¤äººå‘˜å°†ä¼šä»‹å…¥å¤„ç†ã€‚`
            })